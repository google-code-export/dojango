{% load dojango_base %}
{% load dojango_filters %}
{% set_dojango_context %}

{# TODO: Add a css loader to the dojo collector #}
<link rel="stylesheet"
        href="{{ DOJANGO.DOJO_URL }}x/grid/resources/{{ DOJANGO.THEME }}Grid.css"
        type="text/css" />
        
<script type="text/javascript">
if(typeof(dojango) == 'undefined') dojango= {};
if(typeof(dojango._datagrid) == 'undefined') dojango._datagrid= {};
if(typeof(dojango._datagrid._stores) == 'undefined') dojango._datagrid._stores= {};

function {{id}}_noSort(row){ return !( false {{ nosort }} ) }
dojo.addOnLoad(function(){ 
    dojango._datagrid._stores.{{id}}=new dojox.data.QueryReadStore({ url: {{ json_store_url|json|safe }} });
    var {{id}}_layout=[
     {% for x in headers %}
         {field:"{{x.attname}}", name:"{{x.label|safe|capfirst}}", 
          width: "{{x.width}}" {% if x.formatter %}, formatter: {{x.formatter}} {% endif %}  },
     {% endfor %}
    ];
    dojango._datagrid.{{id}}= new dojox.grid.DataGrid({
     jsid: '{{id}}', id:'{{id}}',
     store: dojango._datagrid._stores.{{id}}, structure:{{id}}_layout,
     canSort: {{id}}_noSort
    {% if query %}
     ,query: {{query|safe}}
    {% endif %}
   });
   dijit.byId("{{id}}_container").attr('content',dojango._datagrid.{{id}}.domNode);
   dojango._datagrid.{{id}}.startup();
});

{% if search_fields %}
var {{id}}_last = "";
function do_{{id}}_search(el) {
    if (el.value!={{id}}_last) {
        {{id}}_last = el.value;

        dojango._datagrid.{{id}}.filter( {
            search:el.value, search_fields: '{{search_fields}}'
            {% for k, v in query.items %},'{{k}}':'{{v}}' {%endfor%} 
            },true );
    }
}
{% endif %}
</script>
{% if search_fields %}<div dojoType="dojox.layout.ContentPane" style="width:{{width}};height:20px" >&nbsp;Search:<input style="border:solid 1px #ccc;margin-left:10px" type=text onkeyup="do_{{id}}_search(this)" /></div>{% endif %}
<div id="{{id}}_container" dojoType="dojox.layout.ContentPane" style="width:{{width}}; height:{{height}}"></div>